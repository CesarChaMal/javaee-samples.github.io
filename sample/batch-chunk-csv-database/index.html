<!DOCTYPE html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>JavaEE Sample::Batch::Batch Chunk CSV Database</title><link rel="stylesheet" href="http://javaee.support/stylesheets/foundation-icons.css"><link rel="stylesheet" href="http://javaee.support/stylesheets/app.css"><script src="http://javaee.support/javascripts/vendor/custom.modernizr.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="author" type="text/plain" href="http://javaee.support/humans.txt"><link rel="author" href="https://plus.google.com/101195212405190467512"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Batch Chunk CSV Database"><meta name="twitter:description" content="Chunk Processing - Read, Process, Write to a Database"></head><body class="antialiased"><nav class="top-bar"><ul class="title-area"><li class="name"><h1><a href="http://javaee.support/">JavaEE Samples</a></h1></li><li class="toggle-topbar"><a href="#"><i class="fi-home"></i></a></li></ul><section class="top-bar-section"><ul class="right"><li class="divider"><li><a href="http://javaee.support/contributors">Contributors <i class="fi-torsos-male-female"></i></a></li></li></ul></section></nav><div class="container"><header><div class="row"><div class="large-10 columns"><h2>Batch Chunk CSV Database</h2></div><div class="large-2 columns"><div class="action right"><a class="button radius round success" data-reveal-id="run">Run <i class="fi-play"></i></a><div id="run" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to run the sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/batch/chunk-csv-database/">javaee7-samples</a> <i class="fi-social-github"></i> GitHub repository. The first thing we need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/batch/chunk-csv-database/</code></pre>Now we are ready to start testing. You can run all the tests in this sample by executing:<pre class="highlight"><code>mvn test</code></pre>Or you can run individual tests by executing one of the following:<pre class="highlight"><code>mvn test -Dtest=BatchCSVDatabaseTest</code></pre></hr></div></div></div></div><div class="row"><div class="large-10 columns"><h3>Chunk Processing - Read, Process, Write to a Database</h3></div></div><div class="sub"><div class="row"><div class="large-10 columns specifications"><ul class="inline-list"><li>Specifications in use:</li><li><ul class="inline-list"></ul><li><a href="http://javaee.support/#Batch" title="Batch Processing for Java Platform 1.0">Batch</a></li><li><a href="http://javaee.support/#CDI" title="Context and Dependency Injection 1.1">CDI</a></li><li><a href="http://javaee.support/#JPA" title="Java Persistence API 2.1">JPA</a></li><li><a href="http://javaee.support/#validation" title="Bean Validation 1.1">validation</a></li></li></ul></div><div class="large-2 columns contributors"><ul class="inline-list"><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Arun-gupta"><meta itemprop="affiliation" content="Red Hat Software"><img class="photo" title="Arun-gupta" src="http://gravatar.com/avatar/268f57c236bb50c0f6e12ac38adc9d81?s=25" itemprop="photo"></li><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Roberto Cortez"><meta itemprop="affiliation" content=""><img class="photo" title="Roberto Cortez" src="http://gravatar.com/avatar/d9a06fda174419c0dffb982f226518c2?s=25" itemprop="photo"></li></ul></div></div></div><script type="text/javascript">//$(function() { activateGuideMenuControl() })</script></header><div class="row"><div class="large-12 columns"><div id="test"><div class="row"><div class="large-7 columns"><h4>BatchCSVDatabaseTest</h4></div><div class="large-3 columns"><ul class="inline-list" style="margin-left:0em;"><li style="margin-left: 0.3em"><i class="fi-dislike" title="Not all tests pass on GlassFish 4.0" style="color: red"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly 8.0.0.Final" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly 8.1.0.Final" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly nightly" style="color: green"></i></li></ul></div><div class="large-2 columns"><a class="right" href="https://github.com/javaee-samples/javaee7-samples/edit/master/batch/chunk-csv-database/src/test/java/org/javaee7/batch/chunk/csv/database/BatchCSVDatabaseTest.java"><i class="fi-page-edit"></i></a></div></div><div class="paragraph">
<p>The Batch specification provides a Chunk Oriented processing style. This style is defined by enclosing into a
transaction a set of reads, process and write operations via <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/ItemReader.html" title="javax.batch.api.chunk.ItemReader">ItemReader</a></code>,
<code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/ItemProcessor.html" title="javax.batch.api.chunk.ItemProcessor">ItemProcessor</a></code> and <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/ItemWriter.html" title="javax.batch.api.chunk.ItemWriter">ItemWriter</a></code>. Items are read one at a time, processed
and aggregated. The transaction is then committed when the defined <code>checkpoint-policy</code> is triggered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;job id="myJob" xmlns="http://xmlns.jcp.org/xml/ns/javaee" version="1.0"&gt;
    &lt;step id="myStep" &gt;
        &lt;chunk item-count="3"&gt;
            &lt;reader ref="myItemReader"/&gt;
            &lt;processor ref="myItemProcessor"/&gt;
            &lt;writer ref="myItemWriter"/&gt;
        &lt;/chunk&gt;
    &lt;/step&gt;
&lt;/job&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A very simple job is defined in the <code>myJob.xml</code> file. Just a single step with a reader, a processor and a writer.</p>
</div>
<div class="paragraph">
<p>This job will read a file from the system in CSV format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
public void open(Serializable checkpoint) throws Exception {
    reader = new BufferedReader(
            new InputStreamReader(
                this
                .getClass()
                .getClassLoader()
                .getResourceAsStream("/META-INF/mydata.csv")
            )
        );
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
public String readItem() {
    try {
        return reader.readLine();
    } catch (IOException ex) {
        Logger.getLogger(MyItemReader.class.getName()).log(Level.SEVERE, null, ex);
    }
    return null;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Process the data by transforming it into a <code>Person</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
public Person processItem(Object t) {
    System.out.println("processItem: " + t);

    StringTokenizer tokens = new StringTokenizer((String)t, ",");

    String name = tokens.nextToken();
    String date;

    try {
        date = tokens.nextToken();
        format.setLenient(false);
        format.parse(date);
    } catch (ParseException e) {
        return null;
    }

    return new Person(id++, name, date);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally write the data using JPA to a database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
public void writeItems(List list) {
    System.out.println("writeItems: " + list);
    for (Object person : list) {
        em.persist(person);
    }
}</code></pre>
</div>
</div><div class="paragraph">
<p>We&#8217;re just going to deploy the application as a <code>web archive</code>. Note the inclusion of the following files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-file" data-lang="file">/META-INF/batch-jobs/myJob.xml
/META-INF/persistence.xml
/META-INF/create.sql
/META-INF/drop.sql
/META-INF/mydata.csv</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>myJob.xml</code> file is needed for running the batch definition.</p>
</li>
<li>
<p>The <code>persistence.xml</code> file is needed for JPA configuration, create schema, load-data and drop schema.</p>
</li>
<li>
<p>The <code>create.sql</code> file has the necessary database schema for the data.</p>
</li>
<li>
<p>The <code>drop.sql</code> file has the required commands to drop the database schema created.</p>
</li>
<li>
<p>The <code>mydata.csv</code> file has the data to load into the database.</p>
</li>
</ul>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Deployment
public static WebArchive createDeployment() {
    WebArchive war = ShrinkWrap.create(WebArchive.class)
            .addClass(BatchTestHelper.class)
            .addPackage("org.javaee7.batch.chunk.csv.database")
            .addAsWebInfResource(EmptyAsset.INSTANCE, ArchivePaths.create("beans.xml"))
            .addAsResource("META-INF/batch-jobs/myJob.xml")
            .addAsResource("META-INF/persistence.xml")
            .addAsResource("META-INF/create.sql")
            .addAsResource("META-INF/drop.sql")
            .addAsResource("META-INF/mydata.csv");
    System.out.println(war.toString(true));
    return war;
}</code></pre>
</div>
</div><div class="paragraph">
<p>In the test, we&#8217;re just going to invoke the batch execution and wait for completion. To validate the test
expected behaviour we need to query the <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/runtime/Metric.html" title="javax.batch.runtime.Metric">Metric</a></code> object available in the step execution.</p>
</div>
<div class="paragraph">
<p>The batch process itself will read and write 7 elements of type <code>Person</code>. Commits are executed after 3 elements
are read.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SuppressWarnings("unchecked")
@Test
public void testBatchCSVDatabase() throws Exception {
    JobOperator jobOperator = BatchRuntime.getJobOperator();
    Long executionId = jobOperator.start("myJob", new Properties());
    JobExecution jobExecution = jobOperator.getJobExecution(executionId);

    BatchTestHelper.keepTestAlive(jobExecution);

    List&lt;StepExecution&gt; stepExecutions = jobOperator.getStepExecutions(executionId);
    for (StepExecution stepExecution : stepExecutions) {
        if (stepExecution.getStepName().equals("myStep")) {
            Map&lt;Metric.MetricType, Long&gt; metricsMap = BatchTestHelper.getMetricsMap(stepExecution.getMetrics());

            <b class="conum">(1)</b>
            assertEquals(7L, metricsMap.get(Metric.MetricType.READ_COUNT).longValue());
            <b class="conum">(2)</b>
            assertEquals(7L, metricsMap.get(Metric.MetricType.WRITE_COUNT).longValue());
            <b class="conum">(3)</b>
            assertEquals(3L, metricsMap.get(Metric.MetricType.COMMIT_COUNT).longValue());
        }
    }

    Query query = entityManager.createNamedQuery("Person.findAll");
    List&lt;Person&gt; persons = query.getResultList();

    <b class="conum">(4)</b>
    assertEquals(7L, persons.size());
    <b class="conum">(5)</b>
    assertEquals(jobExecution.getBatchStatus(), BatchStatus.COMPLETED);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The read count should be 7 elements. Check <code>MyItemReader</code>.</p>
</li>
<li>
<p>The write count should be the same 7 read elements.</p>
</li>
<li>
<p>The commit count should be 4. Checkpoint is on every 3rd read, 4 commits for read elements.</p>
</li>
<li>
<p>Confirm that the elements were actually persisted into the database.</p>
</li>
<li>
<p>Job should be completed.</p>
</li>
</ol>
</div></div><script type="text/javascript">$(function() {
  hljs.initHighlightingOnLoad();
})</script></div></div><div class="row"><div class="large-12 columns"><div class="large-6 columns"><h3>Share the Knowledge</h3>Find this sample useful? <a href="http://twitter.com/home/?status=Just%20read%20the%20%23JavaEE-Sample%20%22Batch::Batch%20Chunk%20CSV%20Database%22%20and%20learned%20something%20new!%20http://javaee.support/sample/batch-chunk-csv-database/">Share on <i class="fi-social-twitter"></i></a><p>There's a lot more about JavaEE to cover. If you're ready to learn more, check out the <a href="http://javaee.support/">other available samples</a>.</p></div><div class="large-6 columns"><h3>Help Improve</h3>Find a bug in the sample? Something missing? You can fix it by <a href="https://github.com/javaee-samples/javaee7-samples/edit/master/batch/chunk-csv-database/src/test/java/org/javaee7/batch/chunk/csv/database/BatchCSVDatabaseTest.java">editing the source</a>, making the correction and sending a pull request. Or report the problem to the <a href="https://github.com/javaee-samples/javaee7-samples/issues">issue tracker</a></div></div></div><div class="row"><div class="large-12 columns changes"><h4>Recent Changelog</h4><ul><li>Jul 05, 2014: Removed header license for batch xml files <em>by Roberto Cortez</em></li><li>Jun 22, 2014: Removed header license. the licensing is now referenced in the license file in the root of the project <em>by Roberto Cortez</em></li><li>Jun 20, 2014: Added fqn to java ee api references to generate direct links to javadocs <em>by radcortez</em></li><li>Jun 19, 2014: Documentation clarifications and typos <em>by radcortez</em></li><li>Jun 18, 2014: Added documentation to chunk-csv-database project <em>by radcortez</em></li><li>Dec 31, 2013: Code style issues <em>by Roberto Cortez</em></li><li>Dec 31, 2013: Removed servlets and jsp's <em>by Roberto Cortez</em></li><li>Dec 24, 2013: Changed person entity id generation to be manually assigned <em>by Roberto Cortez</em></li><li>Dec 24, 2013: Added test for chunk-csv-database project <em>by Roberto Cortez</em></li><li>Nov 11, 2013: Fixing https://github.com/arun-gupta/javaee7-samples/pull/32 <em>by Arun Gupta</em></li></ul></div></div><div id="improve" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to help improve this sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/batch/chunk-csv-database/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing you need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/batch/chunk-csv-database/</code></pre><p>Do the changes as you see fit and send a pull request!</p><p>Good Luck!</p></hr></div></div><footer style="max-width: 100%"><div class="row"><div class="large-6 columns" style="margin-bottom: .75em; margin-top: .75em"><ul class="unstyled"><li>&#169; Copyright 2013-2014 JavaEE Samples.</li><li><i class="fi-like"></i>&nbsp;Mixed with <a href="http://foundation.zurb.com/">Foundation</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.</li><li><i class="fi-share"></i>&nbsp;Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</li></ul></div></div></footer><script src="http://javaee.support/javascripts/foundation/foundation.js"></script><script src="http://javaee.support/javascripts/foundation/foundation.topbar.js"></script><script src="http://javaee.support/javascripts/foundation/foundation.reveal.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/styles/pojoaque.css"><script type="text/javascript">$(document).foundation()</script><script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-18727998-5']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
<!DOCTYPE html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>JavaEE Sample::JMS::Temporary destinations</title><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.css"><link rel="stylesheet" href="http://javaee-samples.github.io/stylesheets/foundation-icons.css"><link rel="stylesheet" href="http://javaee-samples.github.io/stylesheets/app.css"><script src="http://javaee-samples.github.io/javascripts/vendor/custom.modernizr.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="author" type="text/plain" href="http://javaee-samples.github.io/humans.txt"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Temporary destinations"><meta name="twitter:description" content="Request/Response over JMS"></head><body class="antialiased"><nav class="top-bar"><ul class="title-area"><li class="name"><h1><a href="http://javaee-samples.github.io/">JavaEE Samples</a></h1></li><li class="toggle-topbar"><a href="#"><i class="fi-home"></i></a></li></ul><section class="top-bar-section"><ul class="right"><li class="divider"><li><a href="http://javaee-samples.github.io/contributors">Contributors <i class="fi-torsos-male-female"></i></a></li></li></ul></section></nav><div class="container"><header><div class="row"><div class="large-10 columns"><h2>Temporary destinations</h2></div><div class="large-2 columns"><div class="action right"><a class="button radius round success" data-reveal-id="run">Run <i class="fi-play"></i></a><div id="run" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to run the sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/jms/temp-destination/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing we need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/jms/temp-destination/</code></pre>Now we are ready to start testing. You can run all the tests in this sample by executing:<pre class="highlight"><code>mvn test</code></pre>Or you can run individual tests by executing one of the following:<pre class="highlight"><code>mvn test -Dtest=TempQueueTest</code></pre></hr></div></div></div></div><div class="row"><div class="large-10 columns"><h3>Request/Response over JMS</h3></div></div><div class="sub"><div class="row"><div class="large-10 columns specifications"><ul class="inline-list"><li>Specifications in use:</li><li><ul class="inline-list"></ul><li><a href="http://javaee-samples.github.io/#CDI" title="Context and Dependency Injection 1.1">CDI</a></li><li><a href="http://javaee-samples.github.io/#EJB" title="Enterprise JavaBeans 3.2">EJB</a></li><li><a href="http://javaee-samples.github.io/#JMS" title="Java Message Service API 2.0">JMS</a></li></li></ul></div><div class="large-2 columns contributors"><ul class="inline-list"><li><img class="photo" title="Arun Gupta" src="http://gravatar.com/avatar/268f57c236bb50c0f6e12ac38adc9d81?s=25"></li><li><img class="photo" title="Aslak Knutsen" src="http://gravatar.com/avatar/3f27861ec08730fd02c91fe4129d2668?s=25"></li><li><img class="photo" title="Patrik DuditÅ¡" src="http://gravatar.com/avatar/19a56ae56e133a56dd06d22be7d283ae?s=25"></li></ul></div></div></div><script type="text/javascript">//$(function() { activateGuideMenuControl() })</script></header><div class="row"><div class="large-12 columns"><div id="test"><div class="row"><div class="large-7 columns"><h4>TempQueueTest</h4></div><div class="large-3 columns"><ul class="inline-list" style="margin-left:0em;"><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on GlassFish" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on wildfly" style="color: green"></i></li></ul></div><div class="large-2 columns"><a class="right" href="https://github.com/javaee-samples/javaee7-samples/edit/master/jms/temp-destination/src/test/java/org/javaee7/jms/temp/destination/TempQueueTest.java"><i class="fi-page-edit"></i></a></div></div><div class="paragraph">
<p>Temporary queues are JMS queues that exist for the lifetime of single JMS connection.
Also the reception of the messages is exclusive to the connection, therefore no
reasonable use case exist for temporary topic within Java EE container, as connection
is exclusive to single component.</p>
</div>
<div class="paragraph">
<p>Temporary queues are usually used as reply channels for request / response communication
over JMS.</p>
</div><div class="paragraph">
<p>In this test we created a server component <code>RequestResponseOverJMS</code>, that
listens on a Queue and passes the response to the destination specified in
<code>JMSReplyTo</code> header of the message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Override
public void onMessage(Message message) {
    try {
        Destination replyTo = message.getJMSReplyTo(); <b>(1)</b>
        if (replyTo == null) {
            return;
        }
        TextMessage request = (TextMessage) message;
        String payload = request.getText();            <b>(2)</b>

        System.out.println("Got request: "+payload);

        String response = "Processed: "+payload;       <b>(3)</b>
        jms.createProducer().send(replyTo, response);  <b>(4)</b>
    } catch (JMSException e) {
        e.printStackTrace();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get the destination for the response</p>
</li>
<li>
<p>read the payload</p>
</li>
<li>
<p>process the request</p>
</li>
<li>
<p>send the response</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>JmsClient</code> is a client to this server, and has to be non transactional,
otherwise the request would be first sent upon commit, i. e. after the
business method finishes. That would be too late. We need to send the message
immediately, and wait for the response to arrive.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@TransactionAttribute(TransactionAttributeType.NOT_SUPPORTED)        <b>(1)</b>
public String process(String request) {

    TextMessage requestMessage = jms.createTextMessage(request);
    TemporaryQueue responseQueue = jms.createTemporaryQueue();
    jms.createProducer()
            .setJMSReplyTo(responseQueue)                            <b>(2)</b>
            .send(requestQueue, requestMessage);                     <b>(3)</b>

    try (JMSConsumer consumer = jms.createConsumer(responseQueue)) { <b>(4)</b>

        String response = consumer.receiveBody(String.class, 2000);  <b>(5)</b>

        if (response == null) {                                      <b>(6)</b>
            throw new IllegalStateException("Message processing timed out");
        } else {
            return response;
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>we need to send message in the middle of the method, therefore we cannot be transactional</p>
</li>
<li>
<p>set the temporary queue as replyToDestination</p>
</li>
<li>
<p>immediately send the request message</p>
</li>
<li>
<p>listen on the temporary queue</p>
</li>
<li>
<p>wait for a <code>TextMessage</code> to arrive</p>
</li>
<li>
<p><code>receiveBody</code>  returns <code>null</code> in case of timeout</p>
</li>
</ol>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Deployment
public static WebArchive deployment() {
    return ShrinkWrap.create(WebArchive.class)
            .addClasses(RequestResponseOverJMS.class, JmsClient.class, Resources.class);
}</code></pre>
</div>
</div><div class="paragraph">
<p>We invoke the client, and verify that the response is processed</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Test
public void testRequestResposne() {
    String response = client.process("Hello");
    Assert.assertEquals("Processed: Hello", response);
}</code></pre>
</div>
</div></div><script type="text/javascript">$(function() {
  hljs.initHighlightingOnLoad();
})</script></div></div><div class="row"><div class="large-12 columns"><div class="large-6 columns"><h3>Share the Knowledge</h3>Find this sample useful? <a href="http://twitter.com/home/?status=Just%20read%20the%20%23JavaEE-Sample%20%22JMS::Temporary%20destinations%22%20and%20learned%20something%20new!%20http://javaee-samples.github.io/sample/jms-temp-destination/">Share on <i class="fi-social-twitter"></i></a><p>There's a lot more about JavaEE to cover. If you're ready to learn more, check out the <a href="http://javaee-samples.github.io/">other available samples</a>.</p></div><div class="large-6 columns"><h3>Help Improve</h3>Find a bug in the sample? Something missing? You can fix it by <a href="https://github.com/javaee-samples/javaee7-samples/edit/master/jms/temp-destination/src/test/java/org/javaee7/jms/temp/destination/TempQueueTest.java">editing the source</a>, making the correction and sending a pull request. Or report the problem to the <a href="https://github.com/javaee-samples/javaee7-samples/issues">issue tracker</a></div></div></div><div class="row"><div class="large-12 columns changes"><h4>Recent Changelog</h4><ul><li><div>Mar 20, 2014: Update arquillian.xml cr1 references to final <em>by Aslak Knutsen</em></div></li><li><div>Jan 12, 2014: Fix tempqueuetest for glassfish <em>by pdudits</em></div></li><li><div>Jan 12, 2014: Improving documentation for tempqueuetest <em>by pdudits</em></div></li><li><div>Jan 11, 2014: Issue #80: test for temporary queue <em>by pdudits</em></div></li><li><div>Sep 12, 2013: Using cdi 1.1 "all" style beans.xml <em>by Arun Gupta</em></div></li><li><div>Aug 29, 2013: Adding a message that this sample is not working right now <em>by Arun Gupta</em></div></li><li><div>Aug 27, 2013: Moving the source code from http://svn.java.net/svn/glassfish~svn/branches/arun/javaee7-samples/samples/ <em>by Arun Gupta</em></div></li></ul></div></div><div id="improve" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to help improve this sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/jms/temp-destination/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing you need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/jms/temp-destination/</code></pre><p>Do the changes as you see fit and send a pull request!</p><p>Good Luck!</p></hr></div></div><footer style="max-width: 100%"><div class="row"><div class="large-6 columns" style="margin-bottom: .75em; margin-top: .75em"><ul class="unstyled"><li>&#169; Copyright 2013-2014 JavaEE Samples.</li><li><i class="fi-like"></i>&nbsp;Mixed with <a href="http://foundation.zurb.com/">Foundation</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.</li><li><i class="fi-share"></i>&nbsp;Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</li></ul></div></div></footer><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.js"></script><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.topbar.js"></script><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.reveal.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/styles/pojoaque.css"><script type="text/javascript">$(document).foundation()</script><script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-18727998-5']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
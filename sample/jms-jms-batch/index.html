<!DOCTYPE html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>JavaEE Sample::JMS::Batch JMS processing</title><link rel="stylesheet" href="http://javaee-samples.github.io/stylesheets/foundation-icons.css"><link rel="stylesheet" href="http://javaee-samples.github.io/stylesheets/app.css"><script src="http://javaee-samples.github.io/javascripts/vendor/custom.modernizr.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="author" type="text/plain" href="http://javaee-samples.github.io/humans.txt"><link rel="author" href="https://plus.google.com/118222277307713726144"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Batch JMS processing"><meta name="twitter:description" content="ItemReader reading from durable subscription"></head><body class="antialiased"><nav class="top-bar"><ul class="title-area"><li class="name"><h1><a href="http://javaee-samples.github.io/">JavaEE Samples</a></h1></li><li class="toggle-topbar"><a href="#"><i class="fi-home"></i></a></li></ul><section class="top-bar-section"><ul class="right"><li class="divider"><li><a href="http://javaee-samples.github.io/contributors">Contributors <i class="fi-torsos-male-female"></i></a></li></li></ul></section></nav><div class="container"><header><div class="row"><div class="large-10 columns"><h2>Batch JMS processing</h2></div><div class="large-2 columns"><div class="action right"><a class="button radius round success" data-reveal-id="run">Run <i class="fi-play"></i></a><div id="run" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to run the sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/jms/jms-batch/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing we need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/jms/jms-batch/</code></pre>Now we are ready to start testing. You can run all the tests in this sample by executing:<pre class="highlight"><code>mvn test</code></pre>Or you can run individual tests by executing one of the following:<pre class="highlight"><code>mvn test -Dtest=JmsItemReaderTest</code></pre></hr></div></div></div></div><div class="row"><div class="large-10 columns"><h3>ItemReader reading from durable subscription</h3></div></div><div class="sub"><div class="row"><div class="large-10 columns specifications"><ul class="inline-list"><li>Specifications in use:</li><li><ul class="inline-list"></ul><li><a href="http://javaee-samples.github.io/#Batch" title="Batch Processing for Java Platform 1.0">Batch</a></li><li><a href="http://javaee-samples.github.io/#CDI" title="Context and Dependency Injection 1.1">CDI</a></li><li><a href="http://javaee-samples.github.io/#EJB" title="Enterprise JavaBeans 3.2">EJB</a></li><li><a href="http://javaee-samples.github.io/#JMS" title="Java Message Service API 2.0">JMS</a></li></li></ul></div><div class="large-2 columns contributors"><ul class="inline-list"><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Aslak Knutsen"><meta itemprop="affiliation" content="Red Hat, Inc."><img class="photo" title="Aslak Knutsen" src="http://gravatar.com/avatar/3f27861ec08730fd02c91fe4129d2668?s=25" itemprop="photo"></li><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Patrik Duditš"><meta itemprop="affiliation" content=""><img class="photo" title="Patrik Duditš" src="http://gravatar.com/avatar/19a56ae56e133a56dd06d22be7d283ae?s=25" itemprop="photo"></li></ul></div></div></div><script type="text/javascript">//$(function() { activateGuideMenuControl() })</script></header><div class="row"><div class="large-12 columns"><div id="test"><div class="row"><div class="large-7 columns"><h4>JmsItemReaderTest</h4></div><div class="large-3 columns"><ul class="inline-list" style="margin-left:0em;"><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on GlassFish 4.0" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-dislike" title="Not all tests pass on WildFly 8.0.0.Final" style="color: red"></i></li><li style="margin-left: 0.3em"><i class="fi-dislike" title="Not all tests pass on WildFly 8.1.0.Final" style="color: red"></i></li></ul></div><div class="large-2 columns"><a class="right" href="https://github.com/javaee-samples/javaee7-samples/edit/master/jms/jms-batch/src/test/java/org/javaee7/jms/batch/JmsItemReaderTest.java"><i class="fi-page-edit"></i></a></div></div><div class="paragraph">
<p>This test demonstrates programmatical creation of durable consumer, and reading
its subscribed messages in a batch job in form of an <code>ItemReader</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Named()
public class JmsItemReader extends AbstractItemReader {

    public JmsItemReader() {
        super();
    }
    @Resource(lookup = Resources.CONNECTION_FACTORY)
    ConnectionFactory factory;
    private JMSContext jms;
    @Resource(lookup = Resources.TOPIC)
    Topic topic;
    private JMSConsumer subscription;

    @Override()
    public void open(Serializable checkpoint) throws Exception {
        jms = factory.createContext();
        subscription = jms.createDurableConsumer(topic, Resources.SUBSCRIPTION);
    }

    @Override()
    public Object readItem() throws Exception {
        Integer item = subscription.receiveBodyNoWait(Integer.class);
        return item;
    }

    @Override()
    public void close() throws Exception {
        subscription.close();
        jms.close();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The items are then fed into the writer, that performs the aggregation and stores
the result into a <code>@Singleton</code> EJB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Named()
public class SummingItemWriter extends AbstractItemWriter {

    public SummingItemWriter() {
        super();
    }
    @Inject()
    ResultCollector collector;
    private int numItems;
    private int sum;

    @Override()
    public void open(Serializable checkpoint) throws Exception {
        numItems = 0;
        sum = 0;
    }

    @Override()
    public void writeItems(List&lt;Object&gt; objects) throws Exception {
        numItems += objects.size();
        sum += computeSum(objects);
    }

    @Override()
    public void close() throws Exception {
        collector.postResult(sum, numItems);
    }

    private int computeSum(List&lt;Object&gt; objects) {
        int subTotal = 0;
        for (Object o : objects) {
            subTotal += (Integer)o;
        }
        return subTotal;
    }
}</code></pre>
</div>
</div><div class="paragraph">
<p>Upon deployment a topic and connection factory for durable subscription are created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@JMSDestinationDefinition(name = Resources.TOPIC, resourceAdapter = "jmsra", interfaceName = "javax.jms.Topic", destinationName = "batch.topic", description = "Batch processing topic")
@JMSConnectionFactoryDefinition(name = Resources.CONNECTION_FACTORY, resourceAdapter = "jmsra", clientId = "batchJob", description = "Connection factory with clientId of the durable subscription")
public class Resources {

    public Resources() {
        super();
    }
    public static final String SUBSCRIPTION = "BatchJob";
    public static final String TOPIC = "java:app/batch/topic";
    public static final String CONNECTION_FACTORY = "java:app/batch/factory";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the subscription itself is created by means of <code>@Singleton</code> <code>@Startup</code> EJB
<code>SubscriptionCreator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@PostConstruct
void createSubscription() {
    try (JMSContext jms = factory.createContext()) { <b class="conum">(1)</b>
        JMSConsumer consumer = jms.createDurableConsumer(topic, Resources.SUBSCRIPTION); <b class="conum">(2)</b>
        consumer.close();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is factory with clientId specified</p>
</li>
<li>
<p>creates durable subscription on the topic</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The job itself computes sum and count of random numbers that are send on the topic.
Note that at time of sending there is no active consumer listening on the topic.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Deployment
public static WebArchive deployment() {
    return ShrinkWrap.create(WebArchive.class)
            .addAsWebInfResource(EmptyAsset.INSTANCE, ArchivePaths.create("beans.xml"))
            .addClass(BatchTestHelper.class)
            .addPackage(JmsItemReader.class.getPackage())
            .addAsResource("META-INF/batch-jobs/jms-job.xml");
}</code></pre>
</div>
</div><div class="paragraph">
<p>In this test case we verify that the subscription is really created upon deployment
and thus messages are waiting for the job even before the first run of it.</p>
</div>
<div class="paragraph">
<p>The subscription is not deleted even after the application is undeployed, because
the physical topic and its subscription in the message broker still exist,
even after the application scoped managed objects are deleted.</p>
</div>
<div class="paragraph">
<p>Following method is used to generate the payload:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">private int sendMessages(int count) {
    int sum = 0;
    Random r = new Random();
    try (JMSContext jms = factory.createContext(Session.AUTO_ACKNOWLEDGE)) {
        JMSProducer producer = jms.createProducer();
        for (int i=0; i&lt; count; i++) {
            int payload = r.nextInt();
            producer.send(topic, payload);
            sum += payload;
        }
    }
    return sum;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we send 10 random numbers, and verify that summing integers works exactly the
same way on both ends. Or that the job really picked up all the numbers submitted
for the computation.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@InSequence(1)
@Test
public void worksAfterDeployment() throws InterruptedException {
    int sum = sendMessages(10);
    runJob();
    assertEquals(10, collector.getLastItemCount());
    assertEquals(sum, collector.getLastSum());
    assertEquals(1, collector.getNumberOfJobs());
}</code></pre>
</div>
</div><div class="paragraph">
<p>To verify that the durable subscription really collects messages we do few
more runs.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@InSequence(2)
@Test
public void worksInMultipleRuns() throws InterruptedException {
    int sum = sendMessages(14);
    runJob();
    assertEquals(14, collector.getLastItemCount());
    assertEquals(sum, collector.getLastSum());
    assertEquals(2, collector.getNumberOfJobs());
    sum = sendMessages(8); <b class="conum">(1)</b>
    sum += sendMessages(4);
    runJob();
    assertEquals(12, collector.getLastItemCount());
    assertEquals(sum, collector.getLastSum());
    assertEquals(3, collector.getNumberOfJobs());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Sending messages from separate connections makes no difference</p>
</li>
</ol>
</div></div><script type="text/javascript">$(function() {
  hljs.initHighlightingOnLoad();
})</script></div></div><div class="row"><div class="large-12 columns"><div class="large-6 columns"><h3>Share the Knowledge</h3>Find this sample useful? <a href="http://twitter.com/home/?status=Just%20read%20the%20%23JavaEE-Sample%20%22JMS::Batch%20JMS%20processing%22%20and%20learned%20something%20new!%20http://javaee-samples.github.io/sample/jms-jms-batch/">Share on <i class="fi-social-twitter"></i></a><p>There's a lot more about JavaEE to cover. If you're ready to learn more, check out the <a href="http://javaee-samples.github.io/">other available samples</a>.</p></div><div class="large-6 columns"><h3>Help Improve</h3>Find a bug in the sample? Something missing? You can fix it by <a href="https://github.com/javaee-samples/javaee7-samples/edit/master/jms/jms-batch/src/test/java/org/javaee7/jms/batch/JmsItemReaderTest.java">editing the source</a>, making the correction and sending a pull request. Or report the problem to the <a href="https://github.com/javaee-samples/javaee7-samples/issues">issue tracker</a></div></div></div><div class="row"><div class="large-12 columns changes"><h4>Recent Changelog</h4><ul><li><div>Mar 20, 2014: Update arquillian.xml cr1 references to final <em>by Aslak Knutsen</em></div></li><li><div>Feb 02, 2014: Fix include expression in test case <em>by Aslak Knutsen</em></div></li><li><div>Jan 17, 2014: Jms batch sample <em>by pdudits</em></div></li></ul></div></div><div id="improve" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to help improve this sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/jms/jms-batch/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing you need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/jms/jms-batch/</code></pre><p>Do the changes as you see fit and send a pull request!</p><p>Good Luck!</p></hr></div></div><footer style="max-width: 100%"><div class="row"><div class="large-6 columns" style="margin-bottom: .75em; margin-top: .75em"><ul class="unstyled"><li>&#169; Copyright 2013-2014 JavaEE Samples.</li><li><i class="fi-like"></i>&nbsp;Mixed with <a href="http://foundation.zurb.com/">Foundation</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.</li><li><i class="fi-share"></i>&nbsp;Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</li></ul></div></div></footer><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.js"></script><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.topbar.js"></script><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.reveal.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/styles/pojoaque.css"><script type="text/javascript">$(document).foundation()</script><script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-18727998-5']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>